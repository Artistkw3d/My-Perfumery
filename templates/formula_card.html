{% extends "base.html" %}
{% block title %}Perfume Vault - Ø¨Ø·Ø§Ù‚Ø© {{ formula.name }}{% endblock %}

{% block extra_css %}
<style>
    .perfume-card {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 15px 50px rgba(0,0,0,0.12);
    }
    .card-hero {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        color: white;
        padding: 50px 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .card-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 30% 50%, rgba(255,215,0,0.08) 0%, transparent 50%),
                    radial-gradient(circle at 70% 50%, rgba(139,92,246,0.08) 0%, transparent 50%);
    }
    .card-hero .brand-name {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 4px;
        opacity: 0.6;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
    }
    .card-hero .perfume-name {
        font-size: 2.8rem;
        font-weight: 300;
        letter-spacing: 3px;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
    }
    .card-hero .perfume-desc {
        font-size: 1.05rem;
        opacity: 0.7;
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.9;
        position: relative;
        z-index: 1;
    }
    .card-hero .status-badge {
        display: inline-block;
        padding: 4px 16px;
        border-radius: 20px;
        font-size: 0.75rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        margin-top: 15px;
        position: relative;
        z-index: 1;
    }
    .card-hero .divider {
        width: 60px;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255,215,0,0.5), transparent);
        margin: 20px auto;
        position: relative;
        z-index: 1;
    }
    .section-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 3px;
        color: #999;
        margin-bottom: 20px;
        text-align: center;
    }

    /* Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ø¹Ø·Ø±ÙŠØ© */
    .families-section {
        padding: 35px 40px;
        background: linear-gradient(180deg, #fafafa, #fff);
        text-align: center;
    }
    .family-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 22px;
        margin: 6px;
        border-radius: 50px;
        background: white;
        box-shadow: 0 3px 15px rgba(0,0,0,0.06);
        border: 1px solid #f0f0f0;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        cursor: default;
    }
    .family-badge:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .family-badge .family-icon {
        font-size: 1.6rem;
    }
    .family-badge .family-info {
        text-align: start;
        line-height: 1.3;
    }
    .family-badge .family-name-ar {
        font-weight: 600;
        color: #333;
    }
    .family-badge .family-name-en {
        font-size: 0.7rem;
        color: #999;
    }
    .family-badge .family-pct {
        font-size: 0.7rem;
        color: #8B5CF6;
        font-weight: 600;
    }

    /* Ø§Ù„Ù‡Ø±Ù… Ø§Ù„Ø¹Ø·Ø±ÙŠ */
    .pyramid-section {
        padding: 35px 40px;
    }
    .pyramid-visual {
        max-width: 700px;
        margin: 0 auto;
    }
    .pyramid-level {
        margin-bottom: 16px;
        border-radius: 16px;
        overflow: hidden;
        transition: transform 0.3s;
    }
    .pyramid-level:hover {
        transform: scale(1.01);
    }
    .pyramid-header {
        padding: 14px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
    }
    .pyramid-header .level-icon {
        font-size: 1.3rem;
    }
    .pyramid-header .level-name {
        font-weight: 700;
        font-size: 0.95rem;
    }
    .pyramid-header .level-name-en {
        font-weight: 400;
        font-size: 0.8rem;
        opacity: 0.7;
        margin-right: 8px;
    }
    .pyramid-header .level-count {
        margin-right: auto;
        font-size: 0.75rem;
        opacity: 0.6;
    }
    .pyramid-top .pyramid-header {
        background: linear-gradient(135deg, #fff8e1, #ffecb3);
        color: #6d4c00;
    }
    .pyramid-heart .pyramid-header {
        background: linear-gradient(135deg, #fce4ec, #f8bbd0);
        color: #880e4f;
    }
    .pyramid-base .pyramid-header {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        color: #1b5e20;
    }
    .pyramid-body {
        padding: 12px 20px;
        background: rgba(255,255,255,0.8);
    }
    .pyramid-top .pyramid-body { background: rgba(255,248,225,0.3); }
    .pyramid-heart .pyramid-body { background: rgba(252,228,236,0.3); }
    .pyramid-base .pyramid-body { background: rgba(232,245,233,0.3); }
    .note-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(0,0,0,0.04);
    }
    .note-item:last-child { border-bottom: none; }
    .note-item .note-icon {
        font-size: 1.2rem;
        width: 35px;
        text-align: center;
    }
    .note-item .note-info {
        flex: 1;
    }
    .note-item .note-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: #333;
    }
    .note-item .note-name-ar {
        font-size: 0.75rem;
        color: #999;
    }
    .note-item .note-family {
        font-size: 0.75rem;
        color: #8B5CF6;
    }
    .note-item .note-odor {
        font-size: 0.75rem;
        color: #666;
        font-style: italic;
    }
    .note-item .note-pct {
        font-size: 0.8rem;
        font-weight: 600;
        color: #555;
        min-width: 50px;
        text-align: left;
    }

    /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
    .card-footer-section {
        padding: 25px 40px;
        background: #fafafa;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: #999;
    }
    .card-footer-section .stats span {
        margin-left: 20px;
    }

    /* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .card-loading {
        text-align: center;
        padding: 60px;
        color: #999;
    }
    .card-loading .spinner-border {
        width: 3rem;
        height: 3rem;
        color: #8B5CF6;
    }
    .empty-level {
        padding: 10px 20px;
        text-align: center;
        color: #ccc;
        font-size: 0.85rem;
        font-style: italic;
    }

    @media print {
        .perfume-card { box-shadow: none !important; border: 1px solid #ddd; }
        .family-badge:hover, .pyramid-level:hover { transform: none; }
        .no-print { display: none !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <div>
        <a href="/formula/{{ formula.id }}" class="btn btn-link text-decoration-none">
            <i class="bi bi-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ±ÙƒÙŠØ¨Ø©
        </a>
        <h2 class="d-inline"><i class="bi bi-card-heading"></i> Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠØ©</h2>
    </div>
    <div>
        <button class="btn btn-outline-primary" onclick="window.print()">
            <i class="bi bi-printer"></i> Ø·Ø¨Ø§Ø¹Ø©
        </button>
    </div>
</div>

<div class="perfume-card" id="perfumeCard">
    <div class="card-loading" id="cardLoading">
        <div class="spinner-border mb-3" role="status"></div>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...</p>
    </div>
    <div id="cardContent" style="display:none;">
        <!-- Hero Section -->
        <div class="card-hero">
            <div class="brand-name" id="brandName"></div>
            <div class="divider"></div>
            <h1 class="perfume-name" id="perfumeName"></h1>
            <p class="perfume-desc" id="perfumeDesc"></p>
            <div class="divider"></div>
            <span class="status-badge" id="statusBadge"></span>
        </div>

        <!-- Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ø¹Ø·Ø±ÙŠØ© -->
        <div class="families-section">
            <div class="section-title">Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ø¹Ø·Ø±ÙŠØ© &mdash; Fragrance Families</div>
            <div id="familiesContainer"></div>
        </div>

        <!-- Ø§Ù„Ù‡Ø±Ù… Ø§Ù„Ø¹Ø·Ø±ÙŠ -->
        <div class="pyramid-section">
            <div class="section-title">Ø§Ù„Ù‡Ø±Ù… Ø§Ù„Ø¹Ø·Ø±ÙŠ &mdash; Fragrance Pyramid</div>
            <div class="pyramid-visual">
                <!-- Top Notes -->
                <div class="pyramid-level pyramid-top">
                    <div class="pyramid-header">
                        <span class="level-icon">â˜€ï¸</span>
                        <span class="level-name">Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ø¹Ø·Ø±</span>
                        <span class="level-name-en">Top Notes</span>
                        <span class="level-count" id="topCount"></span>
                    </div>
                    <div class="pyramid-body" id="topNotes"></div>
                </div>
                <!-- Heart Notes -->
                <div class="pyramid-level pyramid-heart">
                    <div class="pyramid-header">
                        <span class="level-icon">â¤ï¸</span>
                        <span class="level-name">Ù‚Ù„Ø¨ Ø§Ù„Ø¹Ø·Ø±</span>
                        <span class="level-name-en">Heart Notes</span>
                        <span class="level-count" id="heartCount"></span>
                    </div>
                    <div class="pyramid-body" id="heartNotes"></div>
                </div>
                <!-- Base Notes -->
                <div class="pyramid-level pyramid-base">
                    <div class="pyramid-header">
                        <span class="level-icon">ğŸŒ³</span>
                        <span class="level-name">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø·Ø±</span>
                        <span class="level-name-en">Base Notes</span>
                        <span class="level-count" id="baseCount"></span>
                    </div>
                    <div class="pyramid-body" id="baseNotes"></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
        <div class="card-footer-section">
            <div class="stats">
                <span><i class="bi bi-droplet"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª: <strong id="ingCount">-</strong></span>
                <span><i class="bi bi-speedometer2"></i> Ø§Ù„ÙˆØ²Ù†: <strong id="totalWeight">-</strong></span>
            </div>
            <div id="cardDate"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const formulaId = {{ formula.id }};

function loadCard() {
    fetch(`/api/formula/${formulaId}/card`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                document.getElementById('cardLoading').innerHTML = '<p class="text-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                return;
            }

            const f = data.formula;
            const company = data.company;

            // Hero
            document.getElementById('brandName').textContent = company.name || 'Perfume Vault';
            document.getElementById('perfumeName').textContent = f.name;
            document.getElementById('perfumeDesc').textContent = f.description || '';

            const statusMap = {
                'draft': { text: 'Ù…Ø³ÙˆØ¯Ø©', bg: 'rgba(255,255,255,0.15)', color: '#ccc' },
                'testing': { text: 'ØªØ­Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', bg: 'rgba(255,193,7,0.2)', color: '#ffc107' },
                'final': { text: 'Ù…Ø¹ØªÙ…Ø¯Ø©', bg: 'rgba(76,175,80,0.2)', color: '#4caf50' }
            };
            const st = statusMap[f.status] || statusMap['draft'];
            const badge = document.getElementById('statusBadge');
            badge.textContent = st.text;
            badge.style.background = st.bg;
            badge.style.color = st.color;

            // Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
            const familiesHtml = data.families.map(fam => `
                <div class="family-badge">
                    <span class="family-icon">${fam.icon || 'ğŸ”®'}</span>
                    <div class="family-info">
                        <div class="family-name-ar">${fam.name_ar || fam.name}</div>
                        <div class="family-name-en">${fam.name}</div>
                    </div>
                    <span class="family-pct">${fam.percentage}%</span>
                </div>
            `).join('');
            document.getElementById('familiesContainer').innerHTML = familiesHtml;

            // Ø§Ù„Ù‡Ø±Ù…
            renderPyramidLevel('topNotes', 'topCount', data.pyramid.Top || []);
            renderPyramidLevel('heartNotes', 'heartCount', data.pyramid.Heart || []);
            renderPyramidLevel('baseNotes', 'baseCount', data.pyramid.Base || []);

            // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('ingCount').textContent = data.ingredients_count;
            document.getElementById('totalWeight').textContent = data.total_weight.toFixed(2) + ' g';
            document.getElementById('cardDate').textContent = f.created_at ? f.created_at.substring(0, 10) : '';

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            document.getElementById('cardLoading').style.display = 'none';
            document.getElementById('cardContent').style.display = 'block';
        });
}

function renderPyramidLevel(containerId, countId, notes) {
    const container = document.getElementById(containerId);
    const counter = document.getElementById(countId);

    if (!notes.length) {
        container.innerHTML = '<div class="empty-level">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒÙˆÙ†Ø§Øª</div>';
        counter.textContent = '';
        return;
    }

    counter.textContent = notes.length + ' Ù…ÙƒÙˆÙ†';

    container.innerHTML = notes.map(n => `
        <div class="note-item">
            <div class="note-icon">${n.family_icon || 'ğŸ”®'}</div>
            <div class="note-info">
                <div class="note-name">${n.name}</div>
                ${n.name_ar ? `<div class="note-name-ar">${n.name_ar}</div>` : ''}
                <div class="note-family">${n.family_icon || ''} ${n.family_name_ar || n.family_name || ''}</div>
                ${n.odor_description ? `<div class="note-odor">${n.odor_description}</div>` : ''}
            </div>
            <div class="note-pct">${n.percentage}%</div>
        </div>
    `).join('');
}

loadCard();
</script>
{% endblock %}
